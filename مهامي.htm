<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ LANA PRO V10 | Unlimited Storage</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=IBM+Plex+Sans+Arabic:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-sidebar: #1e293b;
            --bg-card: #1e293b;
            --bg-col: #0b1120;
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --accent: #f43f5e;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            --border: 1px solid rgba(148, 163, 184, 0.15);
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; scrollbar-width: thin; scrollbar-color: var(--primary) var(--bg-body); }
        body { font-family: 'IBM Plex Sans Arabic', sans-serif; background: var(--bg-body); color: var(--text-main); font-size: 14px; overflow: hidden; height: 100vh; }
        
        /* Layout */
        .app-layout { display: grid; grid-template-columns: 280px 1fr; height: 100vh; transition: 0.3s; }
        
        /* Sidebar */
        .sidebar { background: var(--bg-sidebar); border-left: var(--border); padding: 1.5rem; display: flex; flex-direction: column; overflow-y: auto; z-index: 50; }
        .logo-area { text-align: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: var(--border); }
        .logo-text { font-family: 'Tajawal'; font-size: 2rem; font-weight: 900; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .nav-header { font-size: 0.75rem; color: var(--text-muted); margin: 1.5rem 0 0.8rem 0; display: flex; justify-content: space-between; align-items: center; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .nav-btn { background: rgba(255,255,255,0.05); border: none; color: var(--text-muted); cursor: pointer; font-size: 0.9rem; padding: 2px 8px; border-radius: 4px; transition: 0.2s; }
        .nav-btn:hover { background: var(--primary); color: white; }
        
        .nav-link { padding: 0.8rem; margin-bottom: 6px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-muted); transition: 0.2s; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background: linear-gradient(90deg, rgba(139, 92, 246, 0.15), transparent); color: var(--text-main); border-right: 3px solid var(--primary); }

        /* Main Area */
        .main { padding: 0; overflow-y: auto; display: flex; flex-direction: column; height: 100%; position: relative; }
        
        /* Top Bar */
        .top-bar { 
            background: rgba(15, 23, 42, 0.9); 
            backdrop-filter: blur(12px); 
            padding: 1rem 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: var(--border);
            position: sticky; top: 0; z-index: 40;
            gap: 1.5rem;
        }
        
        .page-title { min-width: 200px; display: none; }
        @media(min-width: 1200px) { .page-title { display: block; } }

        /* Task Stats Bar */
        .task-stats-bar {
            display: flex;
            align-items: center;
            background: #1e293b;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 0.4rem 1rem;
            gap: 1.5rem;
            height: 46px;
            white-space: nowrap;
        }
        .stat-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; font-weight: 600; color: var(--text-muted); }
        .stat-item b { color: white; font-family: 'Tajawal'; font-size: 1.1rem; }
        .stat-dot { width: 8px; height: 8px; border-radius: 50%; }

        /* Smart Search Bar */
        .search-container { flex: 1; max-width: 500px; position: relative; }
        .search-input { width: 100%; background: #1e293b; border: 1px solid rgba(148, 163, 184, 0.2); padding: 0.8rem 1rem 0.8rem 3rem; border-radius: 12px; color: white; transition: 0.3s; font-size: 0.95rem; height: 46px; }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }

        .view-switcher { background: var(--bg-card); padding: 4px; border-radius: 8px; border: var(--border); display: flex; gap: 4px; flex-shrink: 0; }
        .view-btn { padding: 6px 12px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; border-radius: 6px; font-weight: 600; font-size: 0.85rem; }
        .view-btn.active { background: var(--primary); color: white; }

        /* UI Elements */
        .btn { padding: 0.6rem 1.4rem; border-radius: 8px; border: none; cursor: pointer; font-family: inherit; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.9rem; }
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }
        .btn-success { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
        .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid rgba(148, 163, 184, 0.2); }
        
        /* Kanban */
        .kanban-board { display: flex; gap: 0.8rem; height: 100%; overflow-x: auto; padding: 1.5rem 2rem; align-items: flex-start; width: 100%; }
        .kanban-col { flex: 1 1 0; min-width: 250px; background: var(--bg-col); border-radius: 16px; padding: 1rem; display: flex; flex-direction: column; border: var(--border); max-height: 100%; }
        .col-header { font-weight: 700; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: rgba(255,255,255,0.03); border-radius: 8px; }
        .badge-count { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; }
        .kanban-list { flex: 1; overflow-y: auto; min-height: 100px; padding-right: 4px; }
        .kanban-list.drag-over { background: rgba(139, 92, 246, 0.1); border: 2px dashed var(--primary); border-radius: 12px; }

        /* Cards */
        .task-card { background: var(--bg-card); padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border: var(--border); cursor: grab; transition: all 0.2s; position: relative; box-shadow: var(--shadow); }
        .task-card:hover { transform: translateY(-4px); border-color: var(--primary); box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
        .progress-mini { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 10px; overflow: hidden; }
        .progress-mini-bar { height: 100%; background: var(--success); width: 0%; transition: 0.3s; }
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; background: rgba(255,255,255,0.08); font-weight: 500; }
        .tag-urgent { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); }

        /* Grid */
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; padding: 2rem; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 100; display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-box { background: #1e293b; width: 95%; max-width: 1100px; height: 92vh; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6); overflow: hidden; transform: scale(0.95); transition: 0.3s; }
        .modal-overlay.active .modal-box { transform: scale(1); }
        
        .modal-header { padding: 1.5rem; background: rgba(15, 23, 42, 0.5); border-bottom: var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { flex: 1; overflow-y: auto; padding: 0; display: flex; flex-direction: column; background: #18212f; }
        
        .tabs-nav { display: flex; background: #1e293b; padding: 0 1.5rem; border-bottom: var(--border); gap: 1rem; }
        .tab-btn { padding: 1rem 0.5rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; opacity: 0.7; transition: 0.2s; }
        .tab-btn:hover { opacity: 1; color: var(--text-main); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); opacity: 1; }
        .tab-content { padding: 2rem; display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }
        .form-section { background: rgba(255,255,255,0.02); padding: 1.5rem; border-radius: 12px; border: var(--border); }
        .form-row { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-muted); font-weight: 500; }
        input, select, textarea { width: 100%; background: #0f172a; border: 1px solid rgba(255,255,255,0.1); padding: 0.8rem 1rem; border-radius: 8px; color: white; transition: 0.2s; font-family: inherit; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15); }

        /* Subtasks & Comments */
        .subtask-item { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.03); padding: 0.8rem; border-radius: 8px; margin-bottom: 8px; }
        .subtask-item.done .subtask-text { text-decoration: line-through; color: var(--text-muted); }
        .subtask-check { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
        
        .comments-area { display: flex; flex-direction: column; gap: 1rem; max-height: 400px; overflow-y: auto; padding-right: 5px; margin-bottom: 1rem; }
        .comment-msg { background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 12px; border-bottom-right-radius: 2px; }
        
        /* LOG STYLING */
        .log-container { border-left: 2px solid rgba(255,255,255,0.1); padding-right: 1.5rem; }
        .log-item { position: relative; padding-bottom: 2rem; }
        .log-item::before { content: ''; position: absolute; right: -21px; top: 0; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; border: 3px solid var(--bg-card); box-shadow: 0 0 10px var(--primary); }
        .log-time { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; font-family: monospace; }
        .log-action { font-weight: 500; color: #f1f5f9; font-size: 0.95rem; }

        /* Toast Notification */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--primary); padding: 10px 20px; border-radius: 8px; z-index: 999; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideUp 0.3s; }
        @keyframes slideUp { from {transform: translate(-50%, 20px); opacity:0;} to {transform: translate(-50%, 0); opacity:1;} }

        @media(max-width: 768px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar { position: fixed; transform: translateX(100%); width: 280px; height: 100%; transition: 0.3s; box-shadow: -10px 0 30px rgba(0,0,0,0.5); }
            .sidebar.active { transform: translateX(0); }
            .form-grid { grid-template-columns: 1fr; }
            .top-bar { flex-direction: column; align-items: stretch; gap: 1rem; padding: 1rem; height: auto; }
            .search-container { max-width: 100%; order: 2; }
            .task-stats-bar { order: 1; justify-content: space-between; overflow-x: auto; }
        }
    </style>
</head>
<body>

<div class="app-layout">
    <aside class="sidebar" id="sidebar">
        <div class="logo-area">
            <div class="logo-text">LANA PRO</div>
            <div style="font-size:0.75rem; color:var(--text-muted); opacity:0.8;">V10 UNLIMITED</div>
        </div>

        <div class="nav-header">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
        <div class="nav-link active" onclick="app.setFilter('all', null, 'ğŸ“‹ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø´Ø§Ù…Ù„Ø©')">ğŸ“‹ ÙƒÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…</div>
        <div class="nav-link" onclick="app.setFilter('urgent', null, 'ğŸ”¥ Ø§Ù„Ù…Ù‡Ø§Ù… Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø£Ù‡Ù…ÙŠØ©')">ğŸ”¥ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©</div>
        
        <div class="nav-header">
            <span>Ø§Ù„ÙØ¦Ø§Øª</span>
            <button class="nav-btn" onclick="app.openManage('cats')" title="Ø¥Ø¯Ø§Ø±Ø©">âš™ï¸</button>
        </div>
        <div id="catNavList"></div>

        <div class="nav-header">
            <span>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
            <button class="nav-btn" onclick="app.openManage('depts')" title="Ø¥Ø¯Ø§Ø±Ø©">âš™ï¸</button>
        </div>
        <div id="deptNavList"></div>

        <div class="nav-header">Ø§Ù„Ù†Ø¸Ø§Ù…</div>
        <div class="nav-link" onclick="app.exportData()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</div>
        <div class="nav-link" onclick="document.getElementById('importFile').click()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
        <input type="file" id="importFile" hidden onchange="app.importData(this)" accept=".json">
    </aside>

    <main class="main">
        <div class="top-bar">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%; max-width: 200px; display:none;">
            </div>
            
            <button class="btn btn-ghost" onclick="document.getElementById('sidebar').classList.add('active')" style="display:none; margin-left:10px;" id="menuBtn">â˜°</button>
            <div class="page-title">
                <span id="dateDisplay"></span>
                <h2 id="viewTitle">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø´Ø§Ù…Ù„Ø©</h2> 
            </div>

            <div class="task-stats-bar" id="statsBar">
                <div class="stat-item" title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…">
                    <div class="stat-dot" style="background: white;"></div>
                    <span>Ø§Ù„ÙƒÙ„:</span> <b id="headStatTotal">0</b>
                </div>
                <div class="stat-item" title="Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©">
                    <div class="stat-dot" style="background: var(--success);"></div>
                    <span>Ù…ÙƒØªÙ…Ù„:</span> <b id="headStatDone">0</b>
                </div>
                <div class="stat-item" title="Ø§Ù„Ù…Ù‡Ø§Ù… Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°">
                    <div class="stat-dot" style="background: var(--info);"></div>
                    <span>ØªÙ†ÙÙŠØ°:</span> <b id="headStatProg">0</b>
                </div>
                <div class="stat-item" title="Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©">
                    <div class="stat-dot" style="background: var(--danger);"></div>
                    <span>Ø¹Ø§Ø¬Ù„:</span> <b id="headStatUrg">0</b>
                </div>
            </div>

            <div class="search-container">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" placeholder="Ø¨Ø­Ø« Ø°ÙƒÙŠ: Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø§Ù„ÙˆØµÙ..." oninput="app.search(this.value)">
            </div>
            
            <div style="display: flex; gap: 1rem; align-items: center; flex-shrink: 0;">
                <div class="view-switcher">
                    <button class="view-btn active" onclick="app.switchView('kanban')" id="btnKanban">ğŸ“Š ÙƒØ§Ù†Ø¨Ø§Ù†</button>
                    <button class="view-btn" onclick="app.switchView('grid')" id="btnGrid">ğŸ”² Ø´Ø¨ÙƒØ©</button>
                </div>
                <button class="btn btn-primary" onclick="app.openTaskModal()">+ Ù…Ù‡Ù…Ø©</button>
            </div>
        </div>

        <div id="viewKanban" class="kanban-board">
            <div class="kanban-col">
                <div class="col-header" style="border-right: 4px solid #94a3b8;">Ø¬Ø¯ÙŠØ¯ <span class="badge-count" id="count-Ø¬Ø¯ÙŠØ¯">0</span></div>
                <div class="kanban-list" ondrop="app.drop(event, 'Ø¬Ø¯ÙŠØ¯')" ondragover="app.allowDrop(event)"></div>
            </div>
            <div class="kanban-col">
                <div class="col-header" style="border-right: 4px solid #3b82f6;">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° <span class="badge-count" id="count-Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°">0</span></div>
                <div class="kanban-list" ondrop="app.drop(event, 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°')" ondragover="app.allowDrop(event)"></div>
            </div>
            <div class="kanban-col">
                <div class="col-header" style="border-right: 4px solid #a855f7;">Ù…Ø±Ø§Ø¬Ø¹Ø© <span class="badge-count" id="count-Ù…Ø±Ø§Ø¬Ø¹Ø©">0</span></div>
                <div class="kanban-list" ondrop="app.drop(event, 'Ù…Ø±Ø§Ø¬Ø¹Ø©')" ondragover="app.allowDrop(event)"></div>
            </div>
            <div class="kanban-col">
                <div class="col-header" style="border-right: 4px solid #10b981;">Ù…ÙƒØªÙ…Ù„ <span class="badge-count" id="count-Ù…ÙƒØªÙ…Ù„">0</span></div>
                <div class="kanban-list" ondrop="app.drop(event, 'Ù…ÙƒØªÙ…Ù„')" ondragover="app.allowDrop(event)"></div>
            </div>
        </div>

        <div id="viewGrid" class="grid-view" style="display: none;"></div>
    </main>
</div>

<div class="modal-overlay" id="taskModal">
    <div class="modal-box">
        <div class="modal-header">
            <div>
                <h3 id="modalTitle" style="font-size:1.4rem;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</h3>
                <span style="font-size:0.8rem; color:var(--text-muted)">Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…Ù‡Ù…Ø©</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-danger" onclick="app.deleteTask()" id="btnDeleteTask" style="display:none;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                <button class="btn btn-success" onclick="app.saveTask(false)">âš¡ ØªØ·Ø¨ÙŠÙ‚</button>
                <button class="btn btn-primary" onclick="app.saveTask(true)">ğŸ’¾ Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚</button>
                <button class="btn btn-ghost" onclick="app.closeModal('taskModal')">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
        
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="app.tab('details')">ğŸ“ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
            <button class="tab-btn" onclick="app.tab('subtasks')">âœ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ©</button>
            <button class="tab-btn" onclick="app.tab('comments')">ğŸ’¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</button>
            <button class="tab-btn" onclick="app.tab('docs')">ğŸ“ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</button>
            <button class="tab-btn" onclick="app.tab('log')">ğŸ“œ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„</button>
        </div>

        <div class="modal-body">
            <div id="tab-details" class="tab-content active">
                <div class="form-grid">
                    <div class="form-section">
                        <div class="form-row">
                            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
                            <input type="text" id="inpTitle" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù†Ø§Ù‹..." style="font-size:1.1rem; font-weight:bold;">
                        </div>
                        <div class="form-row">
                            <label>ÙˆØµÙ ÙˆØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</label>
                            <textarea id="inpNotes" rows="6"></textarea>
                        </div>
                    </div>
                    <div class="form-section">
                        <div class="form-row">
                            <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
                            <select id="inpStatus">
                                <option value="Ø¬Ø¯ÙŠØ¯">âšª Ø¬Ø¯ÙŠØ¯</option>
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°">ğŸ”µ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                <option value="Ù…Ø±Ø§Ø¬Ø¹Ø©">ğŸŸ£ Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                <option value="Ù…ÙƒØªÙ…Ù„">ğŸŸ¢ Ù…ÙƒØªÙ…Ù„</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
                            <select id="inpPrio">
                                <option value="Ø¹Ø§Ø¯ÙŠ">Ø¹Ø§Ø¯ÙŠ</option>
                                <option value="Ù…Ù‡Ù…">âš ï¸ Ù…Ù‡Ù…</option>
                                <option value="Ø¹Ø§Ø¬Ù„">ğŸš¨ Ø¹Ø§Ø¬Ù„ Ø¬Ø¯Ø§Ù‹</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Ø§Ù„Ù‚Ø³Ù…</label>
                            <select id="inpDept"></select>
                        </div>
                        <div class="form-row">
                            <label>Ø§Ù„ÙØ¦Ø©</label>
                            <select id="inpCat"></select>
                        </div>
                        <div class="form-row">
                            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
                            <input type="date" id="inpDue">
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-subtasks" class="tab-content">
                <div class="form-section" style="max-width: 800px; margin: 0 auto;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                        <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ù‚Ù‚</h3>
                        <span id="subtaskProgressText" style="color:var(--primary); font-weight:bold;">0%</span>
                    </div>
                    <div style="background:rgba(255,255,255,0.1); height:8px; border-radius:4px; overflow:hidden; margin-bottom:1.5rem;">
                        <div id="subtaskProgressBar" style="width:0%; height:100%; background:var(--success); transition:0.3s;"></div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:1.5rem;">
                        <input type="text" id="inpSubtask" placeholder="Ø£Ø¶Ù Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ©..." onkeypress="if(event.key==='Enter') app.addSubtask()">
                        <button class="btn btn-primary" onclick="app.addSubtask()">Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                    <div id="subtaskList" class="subtask-list"></div>
                </div>
            </div>

            <div id="tab-comments" class="tab-content">
                <div class="form-section" style="max-width: 800px; margin: 0 auto; display:flex; flex-direction:column; height:500px;">
                    <div id="commentsList" class="comments-area" style="flex:1;"></div>
                    <div style="display:flex; gap:10px;">
                        <textarea id="inpComment" rows="2" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹..." style="width:100%;"></textarea>
                        <button class="btn btn-primary" style="height:auto;" onclick="app.addComment()">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </div>

            <div id="tab-docs" class="tab-content">
                <div class="form-section">
                    <div style="border: 2px dashed var(--text-muted); padding: 3rem; text-align: center; border-radius: 12px; cursor: pointer; margin-bottom: 2rem;" onclick="document.getElementById('fileInp').click()">
                        <div style="font-size: 2rem;">â˜ï¸</div>
                        <p>Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ù…Ù„ÙØ§Øª (Ù…Ø³Ø§Ø­Ø© ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©)</p>
                        <input type="file" id="fileInp" hidden onchange="app.uploadFile(this)">
                    </div>
                    <div id="docsList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:1rem;"></div>
                </div>
            </div>

            <div id="tab-log" class="tab-content">
                <div class="form-section">
                    <h3 style="margin-bottom:1.5rem;">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„</h3>
                    <div id="logList" class="log-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="manageModal">
    <div class="modal-box" style="max-width: 400px; height: auto;">
        <div class="modal-header">
            <h3 id="manageTitle">Ø¥Ø¯Ø§Ø±Ø©</h3>
            <button class="btn btn-ghost" onclick="app.closeModal('manageModal')">Ã—</button>
        </div>
        <div class="modal-body" style="padding: 1.5rem;">
            <div style="display: flex; gap: 8px; margin-bottom: 1rem;">
                <input type="text" id="manageInp" placeholder="Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯...">
                <button class="btn btn-primary" onclick="app.addManageItem()">+</button>
            </div>
            <div id="manageList" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<div id="toast" class="toast">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­</div>

<script>
    // --- DATABASE LAYER (INDEXED DB for Unlimited Storage) ---
    const db = {
        name: 'LanaDB_V10',
        version: 1,
        instance: null,

        async init() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(this.name, this.version);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if(!db.objectStoreNames.contains('data')) db.createObjectStore('data', { keyPath: 'id' });
                };
                req.onsuccess = (e) => {
                    this.instance = e.target.result;
                    resolve();
                };
                req.onerror = (e) => reject(e);
            });
        },

        async save(data) {
            if(!this.instance) await this.init();
            return new Promise((resolve, reject) => {
                const tx = this.instance.transaction(['data'], 'readwrite');
                const store = tx.objectStore('data');
                // Store everything under id: 'root'
                const req = store.put({ id: 'root', content: data });
                req.onsuccess = () => resolve();
                req.onerror = (e) => reject(e);
            });
        },

        async load() {
            if(!this.instance) await this.init();
            return new Promise((resolve, reject) => {
                const tx = this.instance.transaction(['data'], 'readonly');
                const store = tx.objectStore('data');
                const req = store.get('root');
                req.onsuccess = () => resolve(req.result ? req.result.content : null);
                req.onerror = (e) => reject(e);
            });
        }
    };

    if(window.innerWidth<=768) document.getElementById('menuBtn').style.display='block';
    document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    const app = {
        data: {
            tasks: [],
            cats: ['ØªØ³ÙˆÙŠÙ‚', 'Ø¨Ø±Ù…Ø¬Ø©', 'ØªØµÙ…ÙŠÙ…', 'Ù…Ø¨ÙŠØ¹Ø§Øª'],
            depts: ['ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª', 'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©', 'Ø§Ù„ØªØ³ÙˆÙŠÙ‚'],
            view: 'kanban', 
            filter: 'all',     
            filterValue: null, 
            searchQuery: '',
            editId: null,
            manageType: null
        },

        async init() {
            try {
                // Try Loading from IndexedDB (Unlimited)
                await db.init();
                const saved = await db.load();
                
                if(saved) {
                    this.data = saved;
                } else {
                    // Fallback to old localStorage for migration if needed
                    const old = localStorage.getItem('lana_v90');
                    if(old) {
                        const parsed = JSON.parse(old);
                        this.data.tasks = parsed.tasks || [];
                        this.data.cats = parsed.cats || this.data.cats;
                        this.data.depts = parsed.depts || this.data.depts;
                        // Migrate to DB
                        await db.save(this.data);
                    }
                }
            } catch(e) { console.error(e); }
            
            this.renderNav();
            this.renderView();
        },

        async save() {
            try {
                await db.save(this.data);
            } catch (e) { alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); }
            this.renderView();
        },

        showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(()=>t.style.display='none', 2000);
        },

        // --- EXPORT / IMPORT ---
        exportData() {
            const dataStr = JSON.stringify(this.data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `LANA_BACKUP_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        },

        importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(!data.tasks) throw new Error("Format error");
                    if(confirm(`Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ù€ ${data.tasks.length} Ù…Ù‡Ù…Ø©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) {
                        this.data = data;
                        await this.save();
                        alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                        location.reload();
                    }
                } catch(err) {
                    alert('âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
                }
                input.value = '';
            };
            reader.readAsText(file);
        },

        // --- CORE: DYNAMIC TITLE & FILTERING ---
        setFilter(type, value = null, title = '') {
            this.data.filter = type;
            this.data.filterValue = value;
            this.data.searchQuery = ''; 
            document.querySelector('.search-input').value = '';

            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            const titleEl = document.getElementById('viewTitle');
            titleEl.style.opacity = 0;
            setTimeout(() => {
                titleEl.innerText = title;
                titleEl.style.opacity = 1;
            }, 200);

            this.renderView();
            if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active');
        },

        search(query) {
            this.data.searchQuery = query.toLowerCase();
            const titleEl = document.getElementById('viewTitle');
            if(query) titleEl.innerText = `Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: "${query}"`;
            else titleEl.innerText = 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø´Ø§Ù…Ù„Ø©';
            this.renderView();
        },

        renderView() {
            let list = this.data.tasks.filter(t => {
                if(this.data.filter === 'urgent' && t.prio !== 'Ø¹Ø§Ø¬Ù„') return false;
                if(this.data.filter === 'cat' && t.cat !== this.data.filterValue) return false;
                if(this.data.filter === 'dept' && t.dept !== this.data.filterValue) return false;

                const q = this.data.searchQuery;
                if(q) {
                    const basicMatch = t.title.toLowerCase().includes(q) || (t.notes || '').toLowerCase().includes(q);
                    const subMatch = (t.subtasks || []).some(s => s.text.toLowerCase().includes(q));
                    const comMatch = (t.comments || []).some(c => c.text.toLowerCase().includes(q));
                    return basicMatch || subMatch || comMatch;
                }
                return true;
            });

            this.updateStats();

            if(this.data.view === 'kanban') this.renderKanban(list);
            else this.renderGrid(list);
        },

        updateStats() {
            const t = this.data.tasks;
            document.getElementById('headStatTotal').innerText = t.length;
            document.getElementById('headStatDone').innerText = t.filter(x => x.status === 'Ù…ÙƒØªÙ…Ù„').length;
            document.getElementById('headStatProg').innerText = t.filter(x => x.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°').length;
            document.getElementById('headStatUrg').innerText = t.filter(x => x.prio === 'Ø¹Ø§Ø¬Ù„').length;
        },

        renderKanban(list) {
            const cols = { 'Ø¬Ø¯ÙŠØ¯': [], 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°': [], 'Ù…Ø±Ø§Ø¬Ø¹Ø©': [], 'Ù…ÙƒØªÙ…Ù„': [] };
            list.forEach(t => {
                if(cols[t.status]) cols[t.status].push(t);
                else cols['Ø¬Ø¯ÙŠØ¯'].push(t);
            });

            Object.keys(cols).forEach(status => {
                document.getElementById(`count-${status}`).innerText = cols[status].length;
                document.querySelector(`.kanban-list[ondrop*='${status}']`).innerHTML = cols[status].map(t => this.cardHTML(t)).join('');
            });
        },

        renderGrid(list) {
            document.getElementById('viewGrid').innerHTML = list.map(t => this.cardHTML(t)).join('');
        },

        cardHTML(t) {
            const totalSub = t.subtasks ? t.subtasks.length : 0;
            const doneSub = t.subtasks ? t.subtasks.filter(s => s.done).length : 0;
            const progress = totalSub === 0 ? 0 : (doneSub / totalSub) * 100;

            return `
            <div class="task-card" draggable="true" ondragstart="app.drag(event, ${t.id})" onclick="app.openTaskModal(${t.id})">
                <div style="font-weight:700; font-size:1.05rem; margin-bottom:8px;">${t.title}</div>
                <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:10px;">
                    <span class="tag ${t.prio==='Ø¹Ø§Ø¬Ù„'?'tag-urgent':''}">${t.prio}</span>
                    <span class="tag">${t.cat}</span>
                </div>
                ${totalSub > 0 ? `
                <div style="margin-bottom:8px;">
                    <div class="progress-mini"><div class="progress-mini-bar" style="width:${progress}%"></div></div>
                </div>` : ''}
                <div style="font-size:0.75rem; color:var(--text-muted); display:flex; justify-content:space-between;">
                    <span>ğŸ“‚ ${t.dept}</span>
                    <div style="display:flex; gap:8px;">
                        ${(t.comments||[]).length ? `<span>ğŸ’¬ ${t.comments.length}</span>` : ''}
                        ${(t.docs||[]).length ? `<span>ğŸ“ ${t.docs.length}</span>` : ''}
                    </div>
                </div>
            </div>`;
        },

        // --- DRAG & DROP & LOGGING ---
        allowDrop(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); },
        drag(ev, id) { ev.dataTransfer.setData("text", id); },
        drop(ev, newStatus) {
            ev.preventDefault();
            document.querySelectorAll('.drag-over').forEach(e => e.classList.remove('drag-over'));
            const id = parseInt(ev.dataTransfer.getData("text"));
            const task = this.data.tasks.find(t => t.id === id);
            if(task && task.status !== newStatus) {
                const old = task.status;
                task.status = newStatus;
                this.logActivity(task, `ğŸ”„ Ù†Ù‚Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† <b>${old}</b> Ø¥Ù„Ù‰ <b>${newStatus}</b>`);
                this.save();
            }
        },

        // --- TASK MODAL ---
        openTaskModal(id = null) {
            this.data.editId = id;
            this.tab('details');
            this.fillSelect('inpCat', this.data.cats);
            this.fillSelect('inpDept', this.data.depts);

            if(id) {
                const t = this.data.tasks.find(x => x.id === id);
                document.getElementById('modalTitle').innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©';
                document.getElementById('inpTitle').value = t.title;
                document.getElementById('inpDept').value = t.dept;
                document.getElementById('inpCat').value = t.cat;
                document.getElementById('inpPrio').value = t.prio;
                document.getElementById('inpDue').value = t.due;
                document.getElementById('inpNotes').value = t.notes;
                document.getElementById('inpStatus').value = t.status;
                document.getElementById('btnDeleteTask').style.display = 'block';
                this.renderSubtasks(t);
                this.renderComments(t);
                this.renderDocs(t.docs);
                this.renderLog(t.log);
            } else {
                document.getElementById('modalTitle').innerText = 'Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©';
                ['inpTitle','inpDue','inpNotes'].forEach(i => document.getElementById(i).value = '');
                document.getElementById('inpStatus').value = 'Ø¬Ø¯ÙŠØ¯';
                document.getElementById('inpPrio').value = 'Ø¹Ø§Ø¯ÙŠ';
                ['subtaskList','commentsList','docsList','logList'].forEach(i => document.getElementById(i).innerHTML = '');
                document.getElementById('btnDeleteTask').style.display = 'none';
            }
            document.getElementById('taskModal').classList.add('active');
        },

        async saveTask(shouldClose = true) {
            const title = document.getElementById('inpTitle').value;
            if(!title) return alert('âŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨');
            
            const id = this.data.editId;
            let task = id ? this.data.tasks.find(t => t.id === id) : { id: Date.now(), created: new Date(), log: [], docs: [], subtasks: [], comments: [] };
            
            if(!id) {
                 this.logActivity(task, 'âœ¨ <b>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©</b>');
                 this.data.tasks.unshift(task);
                 this.data.editId = task.id; 
                 document.getElementById('btnDeleteTask').style.display = 'block';
            } else {
                const old = JSON.parse(JSON.stringify(task)); 
                const newTitle = document.getElementById('inpTitle').value;
                const newPrio = document.getElementById('inpPrio').value;
                const newStatus = document.getElementById('inpStatus').value;
                const newNotes = document.getElementById('inpNotes').value;

                if(old.title !== newTitle) this.logActivity(task, `âœï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†`);
                if(old.prio !== newPrio) this.logActivity(task, `ğŸš© ØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø¥Ù„Ù‰ <b>${newPrio}</b>`);
                if(old.status !== newStatus) this.logActivity(task, `ğŸ”„ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ <b>${newStatus}</b>`);
                if(old.notes !== newNotes) this.logActivity(task, `ğŸ“ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØµÙ`);
            }

            task.title = title;
            task.dept = document.getElementById('inpDept').value;
            task.cat = document.getElementById('inpCat').value;
            task.prio = document.getElementById('inpPrio').value;
            task.due = document.getElementById('inpDue').value;
            task.notes = document.getElementById('inpNotes').value;
            task.status = document.getElementById('inpStatus').value;

            await this.save(); 
            
            if(shouldClose) {
                this.closeModal('taskModal');
                this.showToast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                this.showToast('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª');
            }
        },

        deleteTask() {
            if(confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
                this.data.tasks = this.data.tasks.filter(t => t.id !== this.data.editId);
                this.save();
                this.closeModal('taskModal');
            }
        },

        // --- SUBTASKS, COMMENTS, LOGS, HELPERS ---
        renderSubtasks(task) {
            const list = document.getElementById('subtaskList');
            list.innerHTML = '';
            if(!task.subtasks) task.subtasks = [];
            
            const total = task.subtasks.length;
            const done = task.subtasks.filter(s => s.done).length;
            const pct = total === 0 ? 0 : Math.round((done/total)*100);
            
            document.getElementById('subtaskProgressText').innerText = pct + '%';
            document.getElementById('subtaskProgressBar').style.width = pct + '%';

            task.subtasks.forEach((sub, idx) => {
                const item = document.createElement('div');
                item.className = `subtask-item ${sub.done ? 'done' : ''}`;
                item.innerHTML = `
                    <input type="checkbox" class="subtask-check" ${sub.done ? 'checked' : ''} onchange="app.toggleSubtask(${idx})">
                    <span class="subtask-text" style="flex:1">${sub.text}</span>
                    <button class="btn btn-danger" style="padding:4px 8px; font-size:0.7rem;" onclick="app.deleteSubtask(${idx})">Ã—</button>
                `;
                list.appendChild(item);
            });
        },
        addSubtask() {
            const val = document.getElementById('inpSubtask').value.trim();
            if(!val) return;
            const task = this.getTask();
            if(!task) return alert('Ø§Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹');
            task.subtasks.push({ text: val, done: false });
            document.getElementById('inpSubtask').value = '';
            this.logActivity(task, `ğŸ“Œ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ©: "${val}"`);
            this.save(); this.renderSubtasks(task);
        },
        toggleSubtask(idx) {
            const task = this.getTask();
            const sub = task.subtasks[idx];
            sub.done = !sub.done;
            this.logActivity(task, sub.done ? `âœ… Ø¥ÙƒÙ…Ø§Ù„ Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ©: "${sub.text}"` : `â†©ï¸ Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ù…Ù‡Ù…Ø©: "${sub.text}"`);
            this.save(); this.renderSubtasks(task);
        },
        deleteSubtask(idx) {
            const task = this.getTask();
            const txt = task.subtasks[idx].text;
            task.subtasks.splice(idx, 1);
            this.logActivity(task, `ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ©: "${txt}"`);
            this.save(); this.renderSubtasks(task);
        },
        addComment() {
            const val = document.getElementById('inpComment').value.trim();
            if(!val) return;
            const task = this.getTask();
            if(!task) return alert('Ø§Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹');
            if(!task.comments) task.comments = [];
            task.comments.push({ text: val, time: new Date() });
            document.getElementById('inpComment').value = '';
            this.logActivity(task, `ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯`);
            this.renderComments(task); this.save();
        },
        renderComments(task) {
            const list = document.getElementById('commentsList');
            if(!task.comments || !task.comments.length) { list.innerHTML = '<p style="color:gray;text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª</p>'; return; }
            list.innerHTML = task.comments.map(c => `
                <div class="comment-msg">
                    <div style="font-size:0.7rem; color:var(--primary); margin-bottom:4px;">${new Date(c.time).toLocaleString('ar-SA')}</div>
                    <div>${c.text}</div>
                </div>
            `).join('');
            list.scrollTop = list.scrollHeight;
        },
        uploadFile(input) {
            const file = input.files[0];
            if(!file) return;
            
            // NOTE: IndexedDB handles large files, no need for try/catch memory checks here like before
            const reader = new FileReader();
            reader.onload = (e) => {
                const task = this.getTask();
                if(!task) return alert('Ø§Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹');
                
                task.docs.push({ name: file.name, size: (file.size/1024).toFixed(1)+'KB', data: e.target.result });
                this.logActivity(task, `ğŸ“ Ø±ÙØ¹ Ù…Ù„Ù: <b>${file.name}</b>`);
                this.save().then(() => {
                    this.renderDocs(task.docs);
                    this.showToast('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­');
                }).catch(() => alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸.'));
                
                input.value = '';
            };
            reader.readAsDataURL(file);
        },
        renderDocs(docs) {
            const list = document.getElementById('docsList');
            list.innerHTML = (docs||[]).map((d,i) => `
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                    <div style="font-weight:bold; overflow:hidden; text-overflow:ellipsis;">${d.name}</div>
                    <div style="font-size:0.7rem; color:gray">${d.size}</div>
                    <div style="margin-top:5px; display:flex; gap:5px;">
                        <a href="${d.data}" download="${d.name}" class="btn btn-primary" style="font-size:0.7rem; padding:2px 8px;">ØªØ­Ù…ÙŠÙ„</a>
                        <button class="btn btn-danger" style="font-size:0.7rem; padding:2px 8px;" onclick="app.deleteDoc(${i})">Ø­Ø°Ù</button>
                    </div>
                </div>
            `).join('');
        },
        deleteDoc(i) {
            const task = this.getTask();
            const name = task.docs[i].name;
            task.docs.splice(i, 1);
            this.logActivity(task, `ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ù„Ù: ${name}`);
            this.save(); this.renderDocs(task.docs);
        },
        logActivity(task, action) {
            if(!task.log) task.log = [];
            task.log.unshift({ action, time: new Date() });
            if(this.data.editId === task.id) this.renderLog(task.log);
        },
        renderLog(logs) {
            document.getElementById('logList').innerHTML = (logs||[]).map(l => `
                <div class="log-item">
                    <div class="log-time">${new Date(l.time).toLocaleString('ar-SA', {hour:'numeric', minute:'numeric', day:'numeric', month:'short'})}</div>
                    <div class="log-action">${l.action}</div>
                </div>
            `).join('');
        },
        getTask() { return this.data.tasks.find(t => t.id === this.data.editId); },
        fillSelect(id, arr) { document.getElementById(id).innerHTML = arr.map(x => `<option value="${x}">${x}</option>`).join(''); },
        tab(n) { 
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('tab-'+n).classList.add('active');
            event.target.classList.add('active');
        },
        closeModal(id) { document.getElementById(id).classList.remove('active'); },
        switchView(v) { 
            this.data.view = v; 
            document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById(v==='kanban'?'btnKanban':'btnGrid').classList.add('active');
            document.getElementById('viewKanban').style.display = v==='kanban'?'flex':'none';
            document.getElementById('viewGrid').style.display = v==='grid'?'grid':'none';
            this.renderView();
        },
        renderNav() {
            document.getElementById('catNavList').innerHTML = this.data.cats.map(c => 
                `<div class="nav-link" onclick="app.setFilter('cat', '${c}', 'Ø§Ù„ÙØ¦Ø©: ${c}')">ğŸ”¹ ${c}</div>`).join('');
            document.getElementById('deptNavList').innerHTML = this.data.depts.map(d => 
                `<div class="nav-link" onclick="app.setFilter('dept', '${d}', 'Ø§Ù„Ù‚Ø³Ù…: ${d}')">ğŸ¢ ${d}</div>`).join('');
        },
        openManage(type) {
            this.data.manageType = type;
            document.getElementById('manageTitle').innerText = type === 'cats' ? 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª' : 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…';
            this.renderManageList();
            document.getElementById('manageModal').classList.add('active');
        },
        renderManageList() {
            const list = this.data.manageType === 'cats' ? this.data.cats : this.data.depts;
            document.getElementById('manageList').innerHTML = list.map((item, i) => `
                <div style="display:flex; justify-content:space-between; padding:8px; background:rgba(255,255,255,0.05); margin-bottom:5px; border-radius:6px; align-items:center;">
                    <span>${item}</span>
                    <button class="btn btn-danger" style="padding:2px 8px; font-size:0.8rem;" onclick="app.deleteManageItem(${i})">Ã—</button>
                </div>
            `).join('');
        },
        addManageItem() {
            const val = document.getElementById('manageInp').value;
            if(!val) return;
            (this.data.manageType === 'cats' ? this.data.cats : this.data.depts).push(val);
            document.getElementById('manageInp').value = '';
            this.save(); this.renderManageList(); this.renderNav();
        },
        deleteManageItem(i) {
            if(confirm('Ø­Ø°ÙØŸ')) {
                (this.data.manageType === 'cats' ? this.data.cats : this.data.depts).splice(i, 1);
                this.save(); this.renderManageList(); this.renderNav();
            }
        }
    };

    app.init();
</script>
</body>
</html>